# 502 Bad Gateway Fix

## Problem Identified ‚úÖ
The 502 Bad Gateway error occurs because:
- Nginx was trying to proxy to hardcoded port 8000
- Render assigns dynamic ports via `$PORT` environment variable  
- Port mismatch caused Nginx to fail connecting to FastAPI

## Solution Applied üîß

### Removed Complexity
- ‚ùå No more Nginx (Render handles HTTP routing)
- ‚ùå No more Supervisor (single process is simpler)
- ‚úÖ FastAPI serves both API and static files directly
- ‚úÖ Uses Render's `$PORT` environment variable

### New Dockerfile: `Dockerfile.render-simple`
- Single container with FastAPI only
- Dynamic port binding: `--port ${PORT:-8000}`
- Staged pip installation for network reliability
- Graceful handling of missing ML packages

## Deployment Steps

### Option 1: Updated Blueprint
```bash
# Current render.yaml now uses Dockerfile.render-simple
# Just redeploy the Blueprint
```

### Option 2: Manual Service (If Blueprint Fails)
1. **Create Web Service**
2. **Environment**: Docker  
3. **Dockerfile Path**: `Dockerfile.render-simple`
4. **Build Command**: (leave empty)
5. **Start Command**: (leave empty - uses Dockerfile CMD)

## Testing After Deployment

```bash
# Health check (should return JSON, not HTML)
curl https://your-app.onrender.com/health

# Root endpoint
curl https://your-app.onrender.com/

# Frontend (should serve React app)
curl https://your-app.onrender.com/
```

## Expected Behavior

‚úÖ **Working Responses:**
```json
// https://your-app.onrender.com/health
{
  "status": "healthy", 
  "service": "chat-with-pdf",
  "ml_available": true/false
}

// https://your-app.onrender.com/
{
  "msg": "Chat with PDF API is running",
  "ml_available": true/false  
}
```

‚ùå **502 Error (Fixed):**
```html
<html><head><title>502 Bad Gateway</title></head>...
```

## Architecture Now

```
Request ‚Üí Render Load Balancer ‚Üí FastAPI (serves both API + React)
```

**Before (Broken):**
```
Request ‚Üí Render ‚Üí Nginx ‚Üí ‚ùå localhost:8000 (wrong port) ‚Üí 502 Error
```

## Troubleshooting

If you still get 502 errors:

1. **Check Render logs** for FastAPI startup errors
2. **Verify PORT binding**: App should show `Uvicorn running on 0.0.0.0:XXXX`
3. **Test health endpoint**: Should return JSON, not HTML
4. **Check build logs**: Ensure all dependencies installed

## Rollback Plan

If new deployment fails, you can quickly switch back:
```yaml
# In render.yaml, change to:
dockerfilePath: Dockerfile.simple  # Previous working version
```

The fix removes unnecessary complexity and aligns with Render's architecture! üöÄ
